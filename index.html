<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT-SoVITS 语音合成工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        dark: '#1F2937',
                        light: '#F3F4F6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .btn-hover {
                @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5;
            }
            .model-status {
                @apply inline-block w-2 h-2 rounded-full ml-2;
            }
        }
    </style>
    <style>
        #requestUrlDisplay {
            word-wrap: break-word; /* 长 URL 自动换行 */
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-gradient-to-r from-primary to-primary/80 text-white shadow-md">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold flex items-center">
                <i class="fa fa-microphone mr-3"></i>
                GPT-SoVITS 语音合成工具
            </h1>
            <p class="text-white/80 mt-2">基于预训练模型的高质量语音合成</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 左侧模型选择面板 -->
            <div class="lg:col-span-1 space-y-6">
                <!-- 模型列表 -->
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-dark mb-6 flex items-center">
                        <i class="fa fa-users text-primary mr-2"></i>角色模型列表
                    </h2>
                    
                    <!-- 模型1: Azusa -->
                    <div class="mb-5 pb-5 border-b border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium text-lg">Azusa</h3>
                            <span id="status-Azusa" class="text-sm text-gray-500">
                                未加载 <span class="model-status bg-gray-300"></span>
                            </span>
                        </div>
                        <button id="load-Azusa" class="w-full bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg btn-hover flex items-center justify-center text-sm">
                            <i class="fa fa-check mr-2"></i>使用此模型
                        </button>
                    </div>
                    
                    <!-- 模型2: Azuma -->
                    <div class="mb-5 pb-5 border-b border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium text-lg">Azuma</h3>
                            <span id="status-Azuma" class="text-sm text-gray-500">
                                未加载 <span class="model-status bg-gray-300"></span>
                            </span>
                        </div>
                        <button id="load-Azuma" class="w-full bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg btn-hover flex items-center justify-center text-sm">
                            <i class="fa fa-check mr-2"></i>使用此模型
                        </button>
                    </div>
                    
                    <!-- 模型3: LAPLACE -->
                    <div class="mb-5 pb-5 border-b border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium text-lg">LAPLACE</h3>
                            <span id="status-LAPLACE" class="text-sm text-gray-500">
                                未加载 <span class="model-status bg-gray-300"></span>
                            </span>
                        </div>
                        <button id="load-LAPLACE" class="w-full bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg btn-hover flex items-center justify-center text-sm">
                            <i class="fa fa-check mr-2"></i>使用此模型
                        </button>
                    </div>
                    
                    <!-- 模型4: Nana7mi -->
                    <div class="mb-5 pb-5 border-b border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium text-lg">Nana7mi</h3>
                            <span id="status-Nana7mi" class="text-sm text-gray-500">
                                未加载 <span class="model-status bg-gray-300"></span>
                            </span>
                        </div>
                        <button id="load-Nana7mi" class="w-full bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg btn-hover flex items-center justify-center text-sm">
                            <i class="fa fa-check mr-2"></i>使用此模型
                        </button>
                    </div>
                    
                    <!-- 模型5: XingTong -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium text-lg">XingTong</h3>
                            <span id="status-XingTong" class="text-sm text-gray-500">
                                未加载 <span class="model-status bg-gray-300"></span>
                            </span>
                        </div>
                        <button id="load-XingTong" class="w-full bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg btn-hover flex items-center justify-center text-sm">
                            <i class="fa fa-check mr-2"></i>使用此模型
                        </button>
                    </div>
                </div>

                <!-- 合成参数设置 -->
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-dark mb-4 flex items-center">
                        <i class="fa fa-sliders text-primary mr-2"></i>合成参数
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">语速调整</label>
                            <input type="range" id="speedFactor" min="0.5" max="2.0" step="0.1" value="1.0" 
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>慢</span>
                                <span id="speedValue">1.0x</span>
                                <span>快</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">采样温度 (创意度)</label>
                            <input type="range" id="temperature" min="0.5" max="1.5" step="0.1" value="1.0"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>稳定</span>
                                <span id="temperatureValue">1.0</span>
                                <span>多变</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">文本分割方式</label>
                            <select id="textSplitMethod" class="w-full p-2 border border-gray-300 rounded-lg">
                                <option value="cut0">cut0 (默认)</option>
                                <option value="cut5" selected>cut5 (平衡)</option>
                                <option value="cut10">cut10 (长文本)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 服务控制 -->
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-dark mb-4 flex items-center">
                        <i class="fa fa-cog text-primary mr-2"></i>服务控制
                    </h2>
                    <div class="grid grid-cols-1 gap-3">
                        <button id="restartServer" class="bg-amber-500 hover:bg-amber-600 text-white py-2 px-4 rounded-lg btn-hover flex items-center justify-center">
                            <i class="fa fa-refresh mr-2"></i>重启服务
                        </button>
                    </div>
                    <div class="mt-4 text-sm text-gray-500 hidden">
                        <p>服务地址: <span id="serverAddress">http://127.0.0.1:9880</span></p>
                        <p class="mt-1">服务状态: <span id="serverStatus" class="text-yellow-500">未连接</span></p>
                    </div>
                </div>
            </div>

            <!-- 右侧文本输入和结果 -->
            <div class="lg:col-span-2 space-y-6">
                <!-- 当前选中模型 -->
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-dark mb-4 flex items-center">
                        <i class="fa fa-check-circle text-primary mr-2"></i>当前使用模型
                    </h2>
                    <div id="currentModel" class="p-4 bg-gray-50 rounded-lg border border-gray-100">
                        <p class="text-gray-500">未选择任何模型，请从左侧选择并加载一个模型</p>
                    </div>
                </div>

                <!-- 文本输入区域 -->
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-dark mb-4 flex items-center">
                        <i class="fa fa-file-text text-primary mr-2"></i>输入文本
                    </h2>
                    <div>
                        <textarea id="textInput" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all resize-none" 
                            placeholder="请输入要合成的文本...">我喜欢你</textarea>
                        <div class="flex justify-between mt-3">
                            <span class="text-sm text-gray-500"><span id="charCount">4</span> 字符</span>
                            <button id="loadExampleText" class="text-sm text-primary hover:text-primary/80">
                                <i class="fa fa-magic mr-1"></i>加载示例文本
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="flex gap-4">
                    <button id="generateAudio" class="flex-1 bg-secondary hover:bg-secondary/90 text-white py-3 px-6 rounded-lg text-lg font-medium btn-hover flex items-center justify-center" disabled>
                        <i class="fa fa-play-circle mr-2"></i>生成语音
                    </button>
                    <button id="stopAudio" class="bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 rounded-lg text-lg font-medium btn-hover flex items-center justify-center" disabled>
                        <i class="fa fa-stop-circle mr-2"></i>停止
                    </button>
                </div>

                <!-- 结果和音频播放 -->
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-dark mb-4 flex items-center">
                        <i class="fa fa-volume-up text-primary mr-2"></i>合成结果
                    </h2>
                    <div id="resultArea" class="space-y-4">
                        <!-- 新增：请求URL显示区域 -->
                        <div id="requestUrlDisplay" class="hidden bg-gray-50 border border-gray-100 text-gray-700 px-4 py-3 rounded-lg">
                            <i class="fa fa-link mr-2"></i>
                            <span id="requestUrlText"></span>
                        </div>
                        
                        <div class="hidden" id="loadingIndicator">
                            <div class="flex items-center justify-center py-8">
                                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
                                <p class="ml-4 text-gray-600">正在合成语音，请稍候...</p>
                            </div>
                        </div>
                        
                        <div id="audioPlayerContainer" class="hidden">
                            <audio id="audioPlayer" controls class="w-full bg-gray-100 p-2 rounded-lg">
                                您的浏览器不支持音频播放
                            </audio>
                            <div class="mt-3 flex justify-end">
                                <button id="downloadAudio" class="text-primary hover:text-primary/80 text-sm flex items-center">
                                    <i class="fa fa-download mr-1"></i>下载音频
                                </button>
                            </div>
                        </div>
                        
                        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                            <i class="fa fa-exclamation-circle mr-2"></i>
                            <span id="errorText"></span>
                        </div>
                        
                        <div id="initialMessage" class="text-center py-12 text-gray-500">
                            <i class="fa fa-comment-o text-4xl mb-3 opacity-30"></i>
                            <p>生成的语音将显示在这里</p>
                        </div>
                    </div>
                </div>

                <!-- 历史记录 -->
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold text-dark mb-4 flex items-center">
                        <i class="fa fa-history text-primary mr-2"></i>合成历史
                    </h2>
                    <div id="historyList" class="max-h-60 overflow-y-auto space-y-2">
                        <p class="text-gray-500 text-center py-4">暂无历史记录</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white/80 py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>GPT-SoVITS 语音合成工具 &copy; 2025</p>
            <p class="text-sm mt-2">请确保已启动本地API服务后使用本工具</p>
        </div>
    </footer>

    <script>
        // 角色模型数据（内部使用，不显示在界面上）
        const characterData = {
            "Azusa": {
                gptModel: "C:\\TOOLS\\GPT-SoVITS-v2pro-20250604\\GPT_weights_v2ProPlus\\Azusa-e50.ckpt",
                sovitsModel: "C:\\TOOLS\\GPT-SoVITS-v2pro-20250604\\SoVITS_weights_v2ProPlus\\Azusa_e24_s1104.pth",
                refAudio: "C:\\Games\\001\\Azusa\\Azusa_175.wav",
                exampleText: "还什么上把玩的最菜最怂的就是你了，队友都想赢的，那肯定是我打的还不错。"
            },
            "Azuma": {
                gptModel: "C:\\TOOLS\\GPT-SoVITS-v2pro-20250604\\GPT_weights_v2ProPlus\\Azuma-e50.ckpt",
                sovitsModel: "C:\\TOOLS\\GPT-SoVITS-v2pro-20250604\\SoVITS_weights_v2ProPlus\\Azuma_e25_s2925.pth",
                refAudio: "C:\\Games\\001\\Azuma\\Azuma_279.wav",
                exampleText: "但是家里出了一些事就搁了，处理完事之后他问我还去不去我当时心情挺复杂的因为那件事对我来说影响还有点大。"
            },
            "LAPLACE": {
                gptModel: "C:\\TOOLS\\GPT-SoVITS-v2pro-20250604\\GPT_weights_v2ProPlus\\LAPLACE-e50.ckpt",
                sovitsModel: "C:\\TOOLS\\GPT-SoVITS-v2pro-20250604\\SoVITS_weights_v2ProPlus\\LAPLACE_e24_s1296.pth",
                refAudio: "C:\\Games\\001\\LAPLACE\\LAPLACE_283.wav",
                exampleText: "已经开始有点有点有点有点头晕目眩了啊，就是可能我的这个作息跟大家的作息不太一样。"
            },
            "Nana7mi": {
                gptModel: "C:\\TOOLS\\GPT-SoVITS-v2pro-20250604\\GPT_weights_v2ProPlus\\Nana7mi-e50.ckpt",
                sovitsModel: "C:\\TOOLS\\GPT-SoVITS-v2pro-20250604\\SoVITS_weights_v2ProPlus\\Nana7mi_e24_s1368.pth",
                refAudio: "C:\\Games\\001\\Nana7mi\\Nana7mi_1284.wav",
                exampleText: "这个表情最可爱！为什么立绘糊糊的呀是因为我电脑屏幕太大了嘛我感觉总觉得能看到像素点了都。"
            },
            "XingTong": {
                gptModel: "C:\\TOOLS\\GPT-SoVITS-v2pro-20250604\\GPT_weights_v2ProPlus\\XingTong-e50.ckpt",
                sovitsModel: "C:\\TOOLS\\GPT-SoVITS-v2pro-20250604\\SoVITS_weights_v2ProPlus\\XingTong_e24_s2256.pth",
                refAudio: "C:\\Games\\001\\XingTong\\XingTong_156.wav",
                exampleText: "小星星说感觉过了很长时间，看着完全陌生的衣服，完全陌生的环境。"
            }
        };

        // 当前加载的模型
        let currentLoadedModel = null;
        
        // DOM 元素
        const textInput = document.getElementById('textInput');
        const charCount = document.getElementById('charCount');
        const generateAudioBtn = document.getElementById('generateAudio');
        const stopAudioBtn = document.getElementById('stopAudio');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioPlayerContainer = document.getElementById('audioPlayerContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const initialMessage = document.getElementById('initialMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const speedFactor = document.getElementById('speedFactor');
        const speedValue = document.getElementById('speedValue');
        const temperature = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperatureValue');
        const textSplitMethod = document.getElementById('textSplitMethod');
        const restartServerBtn = document.getElementById('restartServer');
        const serverStatus = document.getElementById('serverStatus');
        const serverAddress = document.getElementById('serverAddress');
        const loadExampleTextBtn = document.getElementById('loadExampleText');
        const downloadAudioBtn = document.getElementById('downloadAudio');
        const historyList = document.getElementById('historyList');
        const currentModelEl = document.getElementById('currentModel');
        // 新增：请求URL显示元素
        const requestUrlDisplay = document.getElementById('requestUrlDisplay');
        const requestUrlText = document.getElementById('requestUrlText');

        // 当前服务地址
        let baseUrl = '/api';
        let currentAudioBlob = null;
        let abortController = null;

        // 初始化页面
        function init() {
            checkServerStatus();
            setupModelButtons();
            addEventListeners();
            // 初始化字符计数
            charCount.textContent = textInput.value.length;
        }

        // 设置模型按钮事件
        function setupModelButtons() {
            // 为每个模型添加加载按钮事件
            Object.keys(characterData).forEach(character => {
                const loadBtn = document.getElementById(`load-${character}`);
                if (loadBtn) {
                    loadBtn.addEventListener('click', async () => {
                        await loadModel(character);
                    });
                }
            });
        }

        // 更新模型状态显示
        function updateModelStatus(character, isLoaded) {
            const statusEl = document.getElementById(`status-${character}`);
            if (statusEl) {
                if (isLoaded) {
                    statusEl.innerHTML = `已加载 <span class="model-status bg-green-500"></span>`;
                    statusEl.className = 'text-sm text-green-600';
                } else {
                    statusEl.innerHTML = `未加载 <span class="model-status bg-gray-300"></span>`;
                    statusEl.className = 'text-sm text-gray-500';
                }
            }
        }

        // 更新当前模型显示
        function updateCurrentModelDisplay(character) {
            if (character) {
                currentModelEl.innerHTML = `
                    <div class="flex items-center">
                        <i class="fa fa-check-circle text-green-500 mr-2"></i>
                        <h3 class="font-medium text-lg">${character}</h3>
                    </div>
                `;
                generateAudioBtn.disabled = false;
            } else {
                currentModelEl.innerHTML = `
                    <p class="text-gray-500">未选择任何模型，请从左侧选择并加载一个模型</p>
                `;
                generateAudioBtn.disabled = true;
            }
        }

        // 检查服务器状态
        async function checkServerStatus() {
            try {
                const response = await fetch(`${baseUrl}/tts?text=test&text_lang=zh&ref_audio_path=test&prompt_lang=zh`, {
                    method: 'GET',
                    timeout: 5000
                });
                if (response.ok || response.status === 400) { // 400是参数错误，但说明服务器已响应
                    serverStatus.textContent = '已连接';
                    serverStatus.className = 'text-green-500';
                } else {
                    throw new Error('服务器响应异常');
                }
            } catch (error) {
                serverStatus.textContent = '未连接';
                serverStatus.className = 'text-red-500';
                showError('无法连接到API服务，请确保服务已启动');
            }
        }

        // 加载单个模型
        async function loadModel(character) {
            // 先将所有模型状态设为未加载
            Object.keys(characterData).forEach(char => {
                if (char !== character) {
                    updateModelStatus(char, false);
                }
            });
            
            // 显示当前模型正在加载
            const statusEl = document.getElementById(`status-${character}`);
            if (statusEl) {
                statusEl.innerHTML = `加载中 <span class="animate-spin model-status bg-blue-500"></span>`;
                statusEl.className = 'text-sm text-blue-600';
            }

            try {
                const data = characterData[character];
                
                // 加载GPT模型
                const gptResponse = await fetch(`${baseUrl}/set_gpt_weights?weights_path=${encodeURIComponent(data.gptModel)}`);
                if (!gptResponse.ok) throw new Error('加载GPT模型失败');
                
                // 加载SoVITS模型
                const sovitsResponse = await fetch(`${baseUrl}/set_sovits_weights?weights_path=${encodeURIComponent(data.sovitsModel)}`);
                if (!sovitsResponse.ok) throw new Error('加载SoVITS模型失败');
                
                // 更新状态
                currentLoadedModel = character;
                updateModelStatus(character, true);
                updateCurrentModelDisplay(character);
                showSuccess(`模型 ${character} 加载成功`);
                return true;
            } catch (error) {
                updateModelStatus(character, false);
                showError(error.message);
                return false;
            }
        }

        // 生成语音
        async function generateAudio() {
            if (!currentLoadedModel) {
                showError('请先加载一个模型');
                return;
            }

            const text = textInput.value.trim();
            if (!text) {
                showError('请输入要合成的文本');
                return;
            }

            const character = currentLoadedModel;
            const data = characterData[character];

            showLoading();
            hideError();
            disableControls(true);

            try {
                abortController = new AbortController();
                
                // 准备请求参数
                const params = new URLSearchParams();
                params.append('text', text);
                params.append('text_lang', 'zh');
                params.append('ref_audio_path', data.refAudio);
                params.append('prompt_lang', 'zh');
                params.append('text_split_method', textSplitMethod.value);
                params.append('speed_factor', speedFactor.value);
                params.append('temperature', temperature.value);

                // 拼接完整请求URL并显示
                const fullUrl = `${baseUrl}/tts?${params.toString()}`;
                requestUrlText.textContent = fullUrl;
                requestUrlDisplay.classList.remove('hidden');
                initialMessage.classList.add('hidden');

                const response = await fetch(fullUrl, {
                    method: 'GET',
                    signal: abortController.signal
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '语音合成失败');
                }

                // 处理音频响应
                const blob = await response.blob();
                currentAudioBlob = blob;
                const audioUrl = URL.createObjectURL(blob);
                
                // 显示音频播放器
                audioPlayer.src = audioUrl;
                audioPlayerContainer.classList.remove('hidden');
                
                // 添加到历史记录
                addToHistory(character, text, audioUrl);

                hideLoading();
            } catch (error) {
                if (error.name !== 'AbortError') {
                    showError(error.message);
                }
                hideLoading();
            } finally {
                disableControls(false);
            }
        }

        // 停止合成
        function stopAudio() {
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
            hideLoading();
            disableControls(false);
        }

        // 添加到历史记录
        function addToHistory(character, text, audioUrl) {
            const historyItem = document.createElement('div');
            historyItem.className = 'p-3 bg-gray-50 rounded-lg border border-gray-100';
            
            const shortText = text.length > 30 ? text.substring(0, 30) + '...' : text;
            
            historyItem.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-medium text-primary">${character}</p>
                        <p class="text-sm text-gray-600 mt-1">${shortText}</p>
                    </div>
                    <audio controls class="w-full mt-2 text-xs">
                        <source src="${audioUrl}" type="audio/wav">
                    </audio>
                </div>
            `;
            
            // 如果是第一条记录，清空"暂无历史"提示
            if (historyList.querySelector('p.text-gray-500')) {
                historyList.innerHTML = '';
            }
            
            historyList.prepend(historyItem);
        }

        // 下载音频
        function downloadAudio() {
            if (!currentAudioBlob) {
                showError('没有可下载的音频');
                return;
            }
            
            const url = URL.createObjectURL(currentAudioBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gpt_sovits_${currentLoadedModel}_${new Date().getTime()}.wav`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 显示加载状态
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
            audioPlayerContainer.classList.add('hidden');
            requestUrlDisplay.classList.remove('hidden'); // 加载时也显示URL
            hideError();
        }

        // 隐藏加载状态
        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        // 显示错误
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            audioPlayerContainer.classList.add('hidden');
            requestUrlDisplay.classList.remove('hidden'); // 错误时也显示URL
            initialMessage.classList.add('hidden');
        }

        // 隐藏错误
        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // 显示成功消息
        function showSuccess(message) {
            // 创建临时成功消息元素
            const successEl = document.createElement('div');
            successEl.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            successEl.innerHTML = `<i class="fa fa-check mr-2"></i>${message}`;
            document.body.appendChild(successEl);
            
            // 3秒后移除
            setTimeout(() => {
                successEl.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                setTimeout(() => successEl.remove(), 500);
            }, 3000);
        }

        // 禁用/启用控件
        function disableControls(disabled) {
            generateAudioBtn.disabled = disabled;
            stopAudioBtn.disabled = !disabled;
            
            // 禁用所有模型加载按钮
            Object.keys(characterData).forEach(character => {
                const loadBtn = document.getElementById(`load-${character}`);
                if (loadBtn) loadBtn.disabled = disabled;
            });
            
            textInput.disabled = disabled;
            speedFactor.disabled = disabled;
            temperature.disabled = disabled;
            textSplitMethod.disabled = disabled;
            restartServerBtn.disabled = disabled;
            loadExampleTextBtn.disabled = disabled;
        }

        // 添加事件监听器
        function addEventListeners() {
            // 文本输入计数
            textInput.addEventListener('input', () => {
                charCount.textContent = textInput.value.length;
                hideError();
            });

            // 语速滑块
            speedFactor.addEventListener('input', (e) => {
                speedValue.textContent = `${e.target.value}x`;
            });

            // 温度滑块
            temperature.addEventListener('input', (e) => {
                temperatureValue.textContent = e.target.value;
            });

            // 生成音频按钮
            generateAudioBtn.addEventListener('click', generateAudio);

            // 停止按钮
            stopAudioBtn.addEventListener('click', stopAudio);

            // 重启服务器
            restartServerBtn.addEventListener('click', async () => {
                if (confirm('确定要重启服务吗？这将中断当前所有操作。')) {
                    try {
                        await fetch(`${baseUrl}/control?command=restart`);
                        showSuccess('服务已发送重启命令');
                        
                        // 重置模型状态
                        Object.keys(characterData).forEach(char => {
                            updateModelStatus(char, false);
                        });
                        currentLoadedModel = null;
                        updateCurrentModelDisplay(null);
                        
                        // 5秒后检查状态
                        setTimeout(checkServerStatus, 5000);
                    } catch (error) {
                        showError('发送重启命令失败');
                    }
                }
            });

            // 加载示例文本
            loadExampleTextBtn.addEventListener('click', () => {
                if (!currentLoadedModel) {
                    showError('请先加载一个模型');
                    return;
                }
                textInput.value = characterData[currentLoadedModel].exampleText;
                charCount.textContent = textInput.value.length;
                hideError();
            });

            // 下载音频
            downloadAudioBtn.addEventListener('click', downloadAudio);

            // 服务器地址更改
            serverAddress.addEventListener('change', (e) => {
                baseUrl = e.target.textContent;
                checkServerStatus();
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
